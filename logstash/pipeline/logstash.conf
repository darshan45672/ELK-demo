input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON from the message field
  json {
    source => "message"
    target => "app"
  }
  
  # Add additional fields for tracking
  mutate {
    add_field => { 
      "pipeline_stage" => "logstash"
      "processed_at" => "%{@timestamp}"
    }
  }
  
  # Optional: Copy timestamp from app logs if present
  if [app][timestamp] {
    date {
      match => [ "[app][timestamp]", "ISO8601" ]
      target => "@timestamp"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-app-logs-%{+YYYY.MM.dd}"
  }
  
  # Debug output (optional - comment out in production)
  stdout {
    codec => rubydebug
  }
}
